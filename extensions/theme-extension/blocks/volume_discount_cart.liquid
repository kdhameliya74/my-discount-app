{% liquid
  assign config_field = shop.metafields.volume_discount.config
  assign show_widget = false

  if cart and config_field and config_field.value != blank
    assign config = config_field.value | parse_json
    assign percent_off = config.percentOff | default: 0 | times: 1
    assign min_qty = config.minQty | default: 2 | times: 1
    assign configured_products = config.products

    if percent_off > 0 and configured_products
      for item in cart.items
        assign item_gid = blank
        if item.product
          assign item_gid = item.product.admin_graphql_api_id
        endif
        if item_gid == blank
          assign item_gid = 'gid://shopify/Product/' | append: item.product_id
        endif

        if configured_products contains item_gid and item.quantity >= min_qty
          assign show_widget = true
          break
        endif
      endfor
    endif
  endif
%}
{% if show_widget %}
  {% render 'volume_discount_message', min_qty: min_qty, percent_off: percent_off %}
{% endif %}

{% schema %}
{
  "name": "Volume discount cart",
  "target": "section",
  "templates": [
    "cart"
  ]
}
{% endschema %}

